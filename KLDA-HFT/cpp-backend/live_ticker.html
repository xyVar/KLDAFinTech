<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLDA-HFT Live Ticker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0e27;
            color: #00ff00;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1f3a;
            border: 2px solid #00ff00;
            border-radius: 8px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        .header .status {
            font-size: 14px;
            color: #888;
        }

        .status.connected {
            color: #00ff00;
        }

        .status.disconnected {
            color: #ff0000;
        }

        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .ticker-card {
            background: #1a1f3a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .ticker-card:hover {
            border-color: #00ffff;
            box-shadow: 0 0 15px #00ffff;
        }

        .ticker-card.stale {
            border-color: #ff4444;
            opacity: 0.6;
        }

        .ticker-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .symbol {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }

        .time-ago {
            font-size: 12px;
            color: #888;
        }

        .time-ago.recent {
            color: #00ff00;
        }

        .time-ago.stale {
            color: #ff4444;
        }

        .price-display {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }

        .price-block {
            flex: 1;
            text-align: center;
        }

        .price-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 20px;
            font-weight: bold;
        }

        .bid-price {
            color: #ff6b6b;
        }

        .ask-price {
            color: #4ecdc4;
        }

        .spread-value {
            color: #ffd93d;
        }

        .volume-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 11px;
        }

        .volume-item {
            text-align: center;
        }

        .volume-label {
            color: #888;
            margin-bottom: 3px;
        }

        .volume-value {
            color: #00ff00;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #1a1f3a;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 12px;
            color: #888;
        }

        .update-count {
            color: #00ff00;
            font-weight: bold;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .blinking {
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>KLDA-HFT LIVE TICKER</h1>
        <div class="status connected" id="status">● CONNECTED</div>
        <div style="margin-top: 10px; font-size: 12px; color: #888;">
            Last Update: <span id="lastUpdate">--</span> |
            Updates: <span class="update-count" id="updateCount">0</span>
        </div>
    </div>

    <div id="error" class="error-message" style="display: none;"></div>

    <div class="ticker-grid" id="tickerGrid">
        <!-- Ticker cards will be inserted here -->
    </div>

    <div class="footer">
        KLDA-HFT Trading System | Pepperstone Broker | Real-time Market Data<br>
        Auto-refresh: Every 1 second
    </div>

    <script>
        let updateInterval = null;
        let lastUpdateTime = Date.now();

        function formatSecondsAgo(seconds) {
            if (seconds < 1) return 'Now';
            if (seconds < 60) return `${Math.floor(seconds)}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function formatNumber(num) {
            return parseFloat(num).toFixed(2);
        }

        function getTimeAgoClass(secondsAgo) {
            if (secondsAgo < 5) return 'recent';
            if (secondsAgo < 300) return '';  // 5 minutes
            return 'stale';
        }

        function createTickerCard(tick) {
            const secondsAgo = tick.seconds_ago || 0;
            const timeAgoClass = getTimeAgoClass(secondsAgo);
            const cardClass = secondsAgo > 300 ? 'ticker-card stale' : 'ticker-card';

            return `
                <div class="${cardClass}">
                    <div class="ticker-header">
                        <div class="symbol">${tick.symbol}</div>
                        <div class="time-ago ${timeAgoClass}">${formatSecondsAgo(secondsAgo)}</div>
                    </div>
                    <div class="price-display">
                        <div class="price-block">
                            <div class="price-label">BID</div>
                            <div class="price-value bid-price">${formatNumber(tick.bid)}</div>
                        </div>
                        <div class="price-block">
                            <div class="price-label">SPREAD</div>
                            <div class="price-value spread-value">${formatNumber(tick.spread)}</div>
                        </div>
                        <div class="price-block">
                            <div class="price-label">ASK</div>
                            <div class="price-value ask-price">${formatNumber(tick.ask)}</div>
                        </div>
                    </div>
                    <div class="volume-info">
                        <div class="volume-item">
                            <div class="volume-label">Volume</div>
                            <div class="volume-value">${tick.volume.toLocaleString()}</div>
                        </div>
                        <div class="volume-item">
                            <div class="volume-label">Buy</div>
                            <div class="volume-value">${tick.buy_volume.toLocaleString()}</div>
                        </div>
                        <div class="volume-item">
                            <div class="volume-label">Sell</div>
                            <div class="volume-value">${tick.sell_volume.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function updateTickers() {
            try {
                // Fetch live_ticks.json from C++ backend
                const response = await fetch('live_ticks.json?' + Date.now());  // Cache bust

                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();

                // Update status
                document.getElementById('status').textContent = '● CONNECTED';
                document.getElementById('status').className = 'status connected';
                document.getElementById('updateCount').textContent = data.update_count || 0;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                document.getElementById('error').style.display = 'none';

                // Update ticker grid
                const grid = document.getElementById('tickerGrid');
                grid.innerHTML = data.ticks.map(tick => createTickerCard(tick)).join('');

                lastUpdateTime = Date.now();

            } catch (error) {
                console.error('Error fetching tickers:', error);

                // Show error message
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `ERROR: ${error.message}. Make sure C++ backend is running!`;
                errorDiv.style.display = 'block';

                // Update status
                document.getElementById('status').textContent = '● DISCONNECTED';
                document.getElementById('status').className = 'status disconnected blinking';

                // Check if data is too old (more than 5 seconds without update)
                if (Date.now() - lastUpdateTime > 5000) {
                    const grid = document.getElementById('tickerGrid');
                    if (!grid.innerHTML) {
                        grid.innerHTML = '<div style="text-align:center; padding:50px; color:#888;">Waiting for data...</div>';
                    }
                }
            }
        }

        // Start updating every 1 second
        updateInterval = setInterval(updateTickers, 1000);

        // Initial update
        updateTickers();
    </script>
</body>
</html>
